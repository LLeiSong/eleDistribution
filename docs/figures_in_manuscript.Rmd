---
title: "Figures used in manuscript and supplementary material"
author: "Lei Song"
date: "2022-10-25"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)

library(sf)
library(here)
library(raster)
library(terra)
library(ggplot2)
library(purrr)
library(pbmcapply)
library(dplyr)
library(tidyverse)
library(ggpubr)
library(stars)
library(ggsflabel)
library(ggsci)
library(ggfx)
library(rnaturalearth)

data_path <- here("data")
rst_path <- file.path(data_path, "rasters")
vct_path <- file.path(data_path, "vectors")
hr_path <- file.path(data_path, "vars_home_range")
pat_path <- file.path(data_path, "vars_patch")
result_path <- here("results")
cnt_path <- file.path(data_path, "connectivity")
cnt_exp_path <- file.path(result_path, "connectivity")
fg_path <- here("docs/figures")
```

## Methodology
### Figure 2: Occurrence datasets

Figure 2 is the figure of datasets, etc.

```{r}
library(ggpattern)

# Read layers
study_area <- read_sf(
    file.path(vct_path, "mainland_tanzania.geojson"))
expert_range_map <- read_sf(
    file.path(data_path, "observations", "range_map.geojson")) %>% 
    filter(range == "Known") %>% 
    mutate(range = "Expert range map")
census_blocks <- read_sf(
    file.path(data_path, "observations", "census.geojson")) %>% 
    mutate(density_bin = mltools::bin_data(
        round(.$density, 2), 
        bins=8, binType = "quantile"))
zone_to_thin <- read_sf(
    file.path(data_path, "observations", "zone_to_thin.geojson")) %>% 
    mutate(zone = "Spatially-thin region")
occ <- read_sf(
    file.path(data_path, "observations", "ele_occurrence.geojson")) %>% 
    mutate(occ = "GBIF")

fname <- file.path(data_path, "observations/genetype_dataset_15_17.csv")
occ2 <- read.csv(fname, stringsAsFactors = FALSE)
occ2 <- st_as_sf(occ2[, c("Lat", "Long")], 
                coords = c("Long", "Lat"),
                crs = 4326) %>% 
    mutate(occ = "Lohay et al. (2020)")
occ <- rbind(occ, occ2)

# Plot
countries <- ne_countries(
    type = 'countries', scale = 'large',
    continent = "Africa", returnclass = 'sf')

# Make overview
overview <- ggplotGrob(
    ggplot() +
        with_shadow(
            geom_sf(data = countries, fill = 'lightgrey', 
                    color = 'black', linewidth = 0.2),
            sigma = 1, x_offset = 2, y_offset = 2) +
        geom_sf(data = study_area, fill = 'orange', 
                color = 'orange', linewidth = 0) +
        coord_sf(xlim = c(-17.892, 51.892), 
                 ylim = c(-35.321, 37.715)) +
        theme_transparent() +
        theme(axis.title = element_blank(),
              axis.text = element_blank(),
              axis.ticks = element_blank(),
              panel.grid.major = element_blank(),
              plot.margin = unit(rep(-0.6, 4), "cm")))

g1 <- ggplot() +
    annotation_custom(grob = overview, 
                      xmin = 37.8, xmax = 40.5,
                      ymin = -2.65, ymax = -0.9) +
    geom_sf(data = study_area, 
            fill = "white", color = "black") +
    geom_sf(data = zone_to_thin, 
            aes(fill = "Spatially-thin region"), 
            alpha = 0.5, show.legend = "polygon") +
    scale_fill_manual(
        NULL, values = "lightblue",
        breaks = 'Spatially-thin region',
        guide = guide_legend(
            override.aes = list(linetype = "blank", 
                                shape = NA),
            order = 3, label.hjust = 0)) +
    ggnewscale::new_scale_fill() +
    geom_sf_pattern(
        data = expert_range_map, 
        pattern = "magick",
        aes(pattern_type = 'Expert range map'),
        pattern_fill = 'black',
        pattern_density = 1,
        pattern_res = 500,
        color = "black", fill = "lightgrey") +
    scale_pattern_type_manual(
        NULL, values = "left45",
        breaks = "Expert range map",
        guide = guide_legend(
            override.aes = list(shape = NA),
            order = 2, label.hjust = 0)) +
    ggnewscale::new_scale_fill() +
    ggnewscale::new_scale_color() +
    geom_sf(data = census_blocks, 
            aes(fill = density_bin), 
            color = "black", size = 0.3) +
    scale_fill_brewer(
        "Census blocks (Elephants per km<sup>2</sup>)", 
        palette = "YlOrRd", direction = 1,
        guide = guide_legend(
            override.aes = list(linetype = "blank", 
                                shape = NA),
            nrow = 3, title.position = "top", 
            order = 4, label.hjust = 0)) +
    ggnewscale::new_scale_fill() +
    ggnewscale::new_scale_color() +
    geom_sf(data = occ, aes(shape = occ, fill = occ), 
            color = "white", size = 0.8,
            stroke = 0.1, show.legend = "point") +
    scale_shape_manual(
        "Occurrence", values = c(21, 24),
        guide = guide_legend(
            override.aes = list(linetype = "blank"),
            order = 1, label.hjust = 0)) +
    scale_fill_manual("Occurrence", values = c("blue", "#00A087B2"),
                      guide = guide_legend(
                          order = 1, label.hjust = 0)) +
    theme_bw() +
    theme(text = element_text(size = 11),
          axis.text = element_text(color = "black"),
          axis.title = element_blank(),
          legend.text = element_text(size = 11),
          legend.spacing.y = unit(0.1, 'cm'),
          legend.margin = margin(rep(0, 4)), 
          legend.key.height= unit(0.4, 'cm'),
          legend.key.width= unit(0.4, 'cm'),
          legend.title = element_markdown(),
          panel.grid.major = element_line(
              color = "lightgrey", linetype = "dotted", linewidth = 0.3),
          plot.margin = unit(c(-4.5, 0, 0, 0), "cm"),
          legend.position = "bottom",
          legend.box.just = "left",
          legend.box = "vertical")

legend <- get_legend(g1 + theme(plot.margin = unit(c(-3, 0, 2, 0), "cm")))

g1 <- g1 + theme(legend.position = "none",
                 plot.margin = unit(c(-4.5, 0, -1, 0), "cm"))

occ_sub1 <- st_intersection(occ, zone_to_thin)
expert_range_map_sub1 <- expert_range_map %>% 
    slice(unique(unlist(st_intersects(occ_sub1, expert_range_map)))) %>% 
    slice(1)
census_blocks_sub1 <- census_blocks %>% 
    slice(unique(unlist(st_intersects(expert_range_map_sub1, census_blocks))))
occ_sub1 <- st_intersection(occ, expert_range_map_sub1)

g2 <- ggplot() +
    scale_fill_manual(
        NULL, values = "lightblue",
        breaks = 'Spatially-thin region',
        guide = guide_legend(
            override.aes = list(linetype = "blank", 
                                shape = NA),
            order = 3, label.hjust = 0)) +
    ggnewscale::new_scale_fill() +
    geom_sf_pattern(
        data = expert_range_map_sub1, 
        pattern = "magick",
        aes(pattern_type = 'Expert range map'),
        pattern_fill = 'black',
        pattern_density = 1,
        pattern_res = 500,
        color = "black", fill = "lightgrey") +
    scale_pattern_type_manual(
        NULL, values = "left45",
        breaks = "Expert range map",
        guide = guide_legend(
            override.aes = list(shape = NA),
            order = 2, label.hjust = 0)) +
    ggnewscale::new_scale_fill() +
    ggnewscale::new_scale_color() +
    geom_sf(data = census_blocks_sub1, 
            aes(fill = density_bin), 
            color = "black", size = 0.3) +
    scale_fill_brewer(
        "Population density\n(Census blocks)", 
        palette = "YlOrRd", direction = 1,
        guide = guide_legend(
            override.aes = list(linetype = "blank", 
                                shape = NA),
            nrow = 3, title.position = "top", 
            order = 4, label.hjust = 0)) +
    ggnewscale::new_scale_fill() +
    ggnewscale::new_scale_color() +
    geom_sf(data = occ_sub1, aes(shape = occ, fill = occ), 
            color = "white", size = 1,
            stroke = 0.1, show.legend = "point") +
    scale_shape_manual(
        "Occurrence", values = c(21, 24),
        guide = guide_legend(
            override.aes = list(linetype = "blank"),
            order = 1, label.hjust = 0)) +
    scale_fill_manual("Occurrence", values = c("blue", "#00A087B2"),
                      guide = guide_legend(
                          order = 1, label.hjust = 0)) +
    theme_void() +
    theme(text = element_text(size = 11),
          legend.text = element_text(size = 11),
          legend.spacing.y = unit(0.1, 'cm'),
          legend.margin = margin(rep(0, 4)), 
          legend.key.height= unit(0.4, 'cm'),
          legend.key.width= unit(0.4, 'cm'),
          plot.margin = unit(c(-4.5, 0, -1, 0), "cm"),
          legend.position = "none",
          legend.box.just = "left",
          legend.box = "vertical")

ggarrange(ggarrange(g1, g2, nrow = 1, widths = c(1, 0.8)), 
          NULL, legend, NULL, nrow = 4, heights = c(3, -0.9, 1, 0.1))

ggsave(file.path(fg_path, "figure1_study_area_140w_120h_500dpi_1.5c.png"), 
       bg = "white", width = 140, height = 120, 
       units = "mm", dpi = 500)
```

## Results

### Statistics: model performance

```{r}
evals_5scale <- evals_train %>% filter(scale == 5) %>% 
    select(CBI, `AUC (ratio)`, TSS, AUC, `f-measure`)

ci <- function(v, conf_level = 0.95) {
    n <- length(v)
    se <- sd(v) / sqrt(n)
    qt(1 - ((1 - conf_level) / 2), n - 1) * se
}

evals_5scale <- evals_5scale %>%
    summarise_all(list(mean = mean, sd = sd, ci = ci))
```

```{r}
load(file.path(result_path, "runs_fs.rda"))
    
eval_fs <- do.call(rbind, lapply(runs, function(run) {
    tabularize_evaluation(run$eval_test)}))
rm(runs)

evals_fs <- eval_fs %>%
    summarise_all(list(mean = mean, sd = sd, ci = ci))
```

```{r}
load(file.path(result_path, "eval_fine_integrated.rda"))
eval_fine_integrated <- do.call(
    rbind, lapply(eval_fine_integrated, function(eval) {
    tabularize_evaluation(eval)}))

eval_fine_integrated <- eval_fine_integrated %>%
    summarise_all(list(mean = mean, sd = sd, ci = ci))
```

### Figure 3: predicted suitability maps

Figure 3 is the combination of predicted suitability maps.

```{r}
# Read layers
study_area <- read_sf(
    file.path(vct_path, "mainland_tanzania.geojson"))

suit_fine_scale <- read_stars(
    file.path(result_path, "landscape_utility_1km.tif")) %>% 
    split("band") %>% select("prediction")

suit_coarse_scale <- read_stars(
    file.path(result_path, "landscape_utility_10km_to_1km.tif")) %>% 
    split("band") %>% select("prediction")

suit_integrated <- read_stars(
    file.path(result_path, "landscape_utility_1km_integrated.tif")) %>% 
    split("band") %>% select("prediction")

suits <- c(suit_coarse_scale, suit_fine_scale, suit_integrated)
names(suits) <- c("Coarse", "Fine", "Integrated")

g1 <- ggplot() +
    geom_stars(data = suits %>% select("Coarse")) +
    scale_fill_viridis_c("Suitability\n(0-1)",
        option = "D", na.value = "transparent") +
    geom_sf(data = study_area, fill = "transparent", color = "black") +
    coord_sf() +
    theme_transparent() +
    theme(text = element_text(size = 12),
          legend.position = "bottom",
          legend.key.height = unit(0.3,"cm"),
          legend.text = element_text(size = 10),
          legend.margin = margin(0,0,0,0),
          legend.box.spacing = unit(0, "pt"),
          strip.text.x = element_text(size = 12, face = "bold"),
          plot.margin = unit(rep(-0.5, 4), "cm"))
g2 <- ggplot() +
    geom_stars(data = suits %>% select("Fine")) +
    scale_fill_viridis_c("Suitability\n(0-1)",
                         option = "D", na.value = "transparent") +
    geom_sf(data = study_area, fill = "transparent", color = "black") +
    coord_sf() +
    theme_transparent() +
    theme(text = element_text(size = 12),
          legend.position = "bottom",
          legend.key.height = unit(0.3,"cm"),
          legend.text = element_text(size = 10),
          legend.margin = margin(0,0,0,0),
          legend.box.spacing = unit(-0.1, "pt"),
          strip.text.x = element_text(size = 12, face = "bold"),
          plot.margin = unit(rep(-0.5, 4), "cm"))
g3 <- ggplot() +
    geom_stars(data = suits %>% select("Integrated")) +
    scale_fill_viridis_c("Suitability\n(0-1)",
                         option = "D", na.value = "transparent") +
    geom_sf(data = study_area, fill = "transparent", color = "black") +
    coord_sf() +
    theme_transparent() +
    theme(text = element_text(size = 12),
          legend.position = "bottom",
          legend.key.height = unit(0.3,"cm"),
          legend.text = element_text(size = 10),
          legend.margin = margin(0,0,0,0),
          legend.box.spacing = unit(-0.1, "pt"),
          strip.text.x = element_text(size = 12, face = "bold"),
          plot.margin = unit(rep(-0.5, 4), "cm"))

# ggarrange(ggarrange(g1 + theme(legend.position = "none"), 
#           g2 + theme(legend.position = "none"), 
#           ncol = 2, nrow = 1, labels = c("A", 'B'),
#           font.label = list(size = 12, color = "black", face = "bold")),
#           g3, ncol = 1, nrow = 2, labels = c("", 'C'),
#           heights = c(1, 2),
#           font.label = list(size = 12, color = "black", face = "bold"))

ggarrange(g1, g2, g3, 
          ncol = 3, nrow = 1,
          labels = c("a", 'b', 'c'),
          font.label = list(size = 18, color = "black", face = "bold"),
          common.legend = TRUE, legend = "bottom")

ggsave(file.path(fg_path, "figure3_suit_maps_190w_65h_500dpi_2c.png"), 
       bg = "white", width = 190, height = 70, 
       units = "mm", dpi = 500)
```

### Figure 4: variable importance at regional scale

```{r}
library(tidytext)

# Fix a name lost bug here
nms <- c(paste0("BIO", c(1, 4, 7, 12, 15)), 
         "NDVI (dry season)", "NDVI (wet season)", "NDVI seasonality",
         "Road density", "River density", "Settlement density",
         "Surface roughness", "Patch density", "Patch richness density",
         "Shannon's diversity index", "Cropland edge density", 
         "Edge density (closed canopy habitat)", 
         "Mean of Contiguity index (open habitat)", 
         "Patch density (open habitat)", "Coverage of open habitat", 
         "Coverage of waterbodies")

abs_mean <- function(v) mean(abs(v))
var_imp <- do.call(rbind, lapply(c(10, 5, 2.5), function(scale){
    load(file.path(result_path, sprintf("runs_%s.rda", scale)))
    
    do.call(rbind, lapply(runs, function(run) {
        shap_train <- run$variable_analysis$SHAP$train %>% 
            as_tibble() %>% 
            summarise(across(all_of(names(.)), abs_mean))
        names(shap_train) <- nms
        shap_test <- run$variable_analysis$SHAP$test %>% 
            as_tibble() %>% 
            summarise(across(all_of(names(.)), abs_mean))
        names(shap_test) <- nms
        rbind(shap_train %>% mutate(type = "train"),
        shap_test %>% mutate(type = "test"))
    })) %>% mutate(scale = scale)
}))

## Reshape the table
var_imp <- var_imp %>% 
    pivot_longer(cols = rev(names(var_imp))[-c(1, 2)],
                 names_to = "variable", values_to = "value") %>% 
    mutate(scale = factor(scale, levels = c(2.5, 5, 10))) %>% 
    mutate(type = factor(type, levels = c("train", "test")))
var_imp <- var_imp %>% filter(type == "test") %>% 
    group_by(type, scale, variable) %>% 
    summarise(value = mean(value)) %>% ungroup()
var_imp_overall <- var_imp %>% group_by(variable) %>% 
    summarise(value = mean(value)) %>% 
    mutate(scale = "overall") %>% 
    mutate(value = value * 1000) %>% 
    arrange(value)
var_imp_overall <- var_imp_overall %>% 
    mutate(variable = factor(
        variable, levels = var_imp_overall$variable))
var_imp <- var_imp %>% group_by(scale, variable) %>% 
    summarise(value = mean(value)) %>% 
    mutate(value = value * 1000) %>% 
    mutate(scale = factor(
        scale, levels = c("2.5", "5", "10"),
        labels = c("2.5 minutes", 
                   "5 minutes", "10 minutes"))) %>% 
    mutate(variable = factor(
        variable, levels = var_imp_overall$variable))

ggplot(var_imp, aes(x = variable, y = value)) +
    geom_bar(data = var_imp_overall, aes(fill = "Overall"),
             stat = "identity", color = "transparent",
             position="identity") +
    geom_point(aes(color = scale), shape = "|", size = 4) +
    geom_point(aes(y = value + 0.01, color = scale), 
               shape = "|", size = 4) +
    geom_point(aes(y = value + 0.05, color = scale), 
               shape = "|", size = 4) +
    geom_point(aes(y = value + 0.09, color = scale), 
               shape = "|", size = 4) +
    scale_fill_manual(NULL, values = "black",
                      breaks = 'Overall') +
    scale_color_brewer("Scale", palette = "Dark2") +
    ylab('mean(|Shapley value|) * 1000') +
    xlab('Environmental variable') +
    coord_flip() +
    theme_pubclean() +
    theme(text = element_text(size = 12, color = "black"),
          axis.text.x = element_text(angle = 0),
          axis.text = element_text(size = rel(0.8), color = "black"),
          axis.title = element_text(size = rel(1)),
          legend.text = element_text(size = rel(1)),
          legend.position = "top", legend.justification = 'right',
          strip.text.x = element_text(size = 12, face = "bold")) +
    guides(fill = guide_legend(nrow = 1))

ggsave(file.path(fg_path, "figure4_var_imp_coarse_140w_112h_500dpi_1.5c.png"), 
       bg = "white", width = 140, height = 112, 
       units = "mm", dpi = 500)
```

### Figure 5: variable importance at landscape scale

```{r}
# Define names
nms <- c("BIO4", "NDVI seasonality",
         "Distance to settlements", "Distance to waterbodies",
         "Vector ruggedness measure (3km)", 
         "Mean of Contiguity index (open habitat, 3km)", 
         "Cropland edge density (7km)", "Coverage of open habitat (7km)",
         "Patch density (open habitat, 3km)")

abs_mean <- function(v) mean(abs(v))
load(file.path(result_path, "runs_fs.rda"))
var_imp <- do.call(rbind, lapply(runs, function(run) {
    shap_test <- run$variable_analysis$SHAP$test %>% 
        as_tibble() %>% 
        summarise(across(all_of(names(.)), abs_mean))
    names(shap_test) <- nms
    shap_test
})); rm(runs)

## Reshape the table
var_imp <- var_imp %>% 
    pivot_longer(
        cols = names(var_imp),
        names_to = "variable", values_to = "value")
var_imp <- var_imp %>% 
    group_by(variable) %>% 
    summarise(value = mean(value)) %>% 
    ungroup() %>% arrange(value)
var_imp <- var_imp %>% 
    mutate(value = value * 1000) %>% 
    mutate(variable = factor(
        variable, levels = var_imp$variable))

ggplot(var_imp, aes(x = variable, y = value)) +
    geom_bar(fill = "black",
             stat = "identity", color = "transparent",
             position="identity") +
    ylab('mean(|Shapley value|) * 1000') +
    xlab('Environmental variable') +
    coord_flip() +
    theme_pubclean() +
    theme(text = element_text(size = 12, color = "black"),
          axis.text.x = element_text(angle = 0),
          axis.text = element_text(size = rel(0.8), color = "black"),
          axis.title = element_text(size = rel(1)),
          legend.text = element_text(size = rel(1)),
          legend.position = "top", legend.justification = 'right',
          strip.text.x = element_text(size = 12, face = "bold")) +
    guides(fill = guide_legend(nrow = 1))

ggsave(file.path(fg_path, "figure5_var_imp_fine_140w_56h_500dpi_1.5c.png"), 
       bg = "white", width = 140, height = 56, 
       units = "mm", dpi = 500)
```

### Figure 6: landscape connectivity between habitat clusters

Figure 6 is the landscape connectivity for long-distance migration.

```{r}
library(stars)
library(classInt)
library(rmapshaper)
library(colorspace)
library(biscale)
library(tidyterra)

# Read data
bry <- st_read(file.path(vct_path, "mainland_tanzania.geojson"))
habitat_clusters <- st_read(file.path(cnt_path, "habitat_clusters.geojson"))
pas <- st_read(file.path(cnt_path, "pas.geojson"))

## Prepare ancillary elements in the figure
waters <- read_sf(here("data/osm/gis_osm_water_a_free_1.shp")) %>% 
    filter(osm_id %in% c(13419394, 13419395, 1000596431, 2606941)) %>% 
    select(name) %>% ms_simplify() %>% 
    st_crop(bry)
waters$name[3:4] <- "Wetland"

#  Potential corridors
lcp <- read_sf(
    file.path(cnt_exp_path, "least_cost_examples.geojson"))

# Convert maps
## Read the layers
current_map <- rast(
    file.path(cnt_exp_path, "connectivity_long.tif"))
cropland <- rast(file.path(cnt_path, "cropland_ratio.tif")) %>% 
    mask(current_map)

## Convert values to biviariates
data <- values(c(current_map, cropland)) %>% data.frame()
names(data) <- c("Connectivity", "Cropland")
data <- bi_class(data %>% na.omit(), x = Connectivity, y = Cropland, style = "quantile", dim = 4)

## Burn the values into a new layer
rst <- current_map
vals <- values(rst)
vals[!is.na(vals)] <- data$bi_class
values(rst) <- vals
rst[rst == "NaN"] <- NA

# Read ancillary layers
pas <- st_read(file.path(cnt_path, "pas_selected.geojson"))
parks <- pas %>% 
    filter(str_detect(NAME, "Wami"))
parks2 <- pas %>% 
    filter(str_detect(NAME, "Tarangire|Talamai|Irkishbor|Makame"))

## Plot it
### Make a separate legend
legend <- bi_legend(pal = "BlueOr",
                    dim = 4,
                    xlab = "Connectivity",
                    ylab = "Farm coverage",
                    size = 8, arrows = TRUE,  pad_width = 0.1) +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),  
          plot.background = element_rect(fill = "transparent", colour = NA),
          axis.title = element_text(size = 9, color = 'black'))
legend <- ggplotGrob(legend)

legend1 <- ggplot() +
    geom_raster(data = data.frame(x = 1, y = 1, z = factor(1)),
                aes(x = x, y = y, fill = z)) +
    scale_fill_manual("", values = "#FAE48BFF", # "#D0DFE6FF" 
                      labels = "Habitat cluster",
                      na.translate = FALSE,
                      guide = guide_legend(order = 1, byrow = FALSE)) +
    theme(text = element_text(size = 11),
          legend.position = "bottom",
          legend.spacing.y = unit(0.3, 'cm'),
          legend.box = "vertical",
          legend.key.height = unit(0.3,"cm"),
          legend.key.width = unit(0.3,"cm"),
          plot.margin = unit(rep(0, 4), "cm"),
          legend.margin = margin(rep(-1, 4)),
          legend.box.margin = margin(rep(-1, 4)))
legend1 <- get_legend(legend1)

legend2 <- ggplot() +
    geom_sf(data = lcp, aes(color = "Least-cost path"), linewidth = 1) +
    scale_color_manual("", values = c("#EFD500FF"), 
                       labels = c("Least-cost path"),
                       guide = guide_legend(order = 1, byrow = FALSE)) +
    theme(text = element_text(size = 11),
          legend.position = "bottom",
          legend.spacing.y = unit(0.3, 'cm'),
          legend.box = "vertical", 
          legend.key.height = unit(0.3,"cm"),
          legend.key.width = unit(0.3,"cm"),
          plot.margin = unit(rep(0, 4), "cm"),
          legend.margin = margin(rep(-1, 4)),
          legend.box.margin = margin(rep(-1, 4)))
legend2 <- get_legend(legend2)

### Put everything together
ggplot() +
    geom_spatraster(data = rst, show.legend = FALSE) +
    bi_scale_fill(pal = "BlueOr", dim = 4, na.value = NA) +
    geom_sf(data = parks, color = "white", 
            fill = "transparent", linewidth = 0.2) +
    annotate("text", x = 37.5, y = -6.3, label = "a", 
             size = 4, color = "white") +
    geom_sf(data = waters %>% filter(name != "Lake Victoria") %>% st_union(), 
            color = "white", fill = "transparent", linewidth = 0.2) +
    annotate("text", x = 33.7, y = -4.4, label = "b", 
             size = 4, color = "white") +
    geom_sf(data = lcp, color = "#EFD500FF", linewidth = 0.4) +
    geom_sf(data = habitat_clusters, fill = "#FAE48BFF", 
            color = "#FAE48BFF", linewidth = 0.4) +
    geom_sf(data = parks2, color = "black", 
            fill = "transparent", linewidth = 0.2) +
    annotate("text", x = 36.6, y = -4.2, label = "c", 
             size = 4, color = "black") +
    geom_sf(data = waters %>% filter(name == "Lake Victoria"), 
            color = "#00A087FF", fill = "transparent", linewidth = 0.2) +
    geom_sf_text(data = waters %>% filter(name == "Lake Victoria"),
                 aes(label = name), nudge_y = 0.5, nudge_x = 0.3,
                 colour = "black", size = 3) +
    geom_sf(data = bry, color = "black", 
            fill = "transparent", linewidth = 0.3) +
    annotate("text", x = c(35.69, 37.43, 32.48), y = c(-2.57, -9.18, -6.9), 
             label = c(1, 2, 3), fontface = 'bold', size = 4) +
    annotation_custom(grob = legend, 
                      xmin = 28.2, xmax = 33.3,
                      ymin = -13.3, ymax = -8.2) +
    annotation_custom(grob = legend1, 
                      xmin = 32.1, xmax = 37.2,
                      ymin = -15, ymax = -9.9) +
    annotation_custom(grob = legend2, 
                      xmin = 36.1, xmax = 41.2,
                      ymin = -15, ymax = -9.9) +
    xlab("") + ylab("") +
    bi_theme(bg_color = "white") +
    theme(plot.margin = unit(-c(.7, 1.2, 1.0, 2.2), "cm"))

ggsave(file.path(fg_path, "figure6_connectivity.png"), 
       bg = "white", width = 90, height = 90, 
       units = "mm", dpi = 500)
```

### Figure S8: separate maps of cropland coverage and landscape connectivity for Figure 6.

```{r}
# Convert maps
## Read the layers
current_map <- rast(
    file.path(cnt_exp_path, "connectivity_long.tif"))
cropland <- rast(file.path(cnt_path, "cropland_ratio.tif")) %>% 
    mask(current_map)

## Plot it
legend2 <- ggplot() +
    geom_spatraster(data = cropland * 100) +
    scale_fill_material("light-blue", name = "Cropland (%)", na.value = NA) +
    theme(plot.margin = unit(rep(0, 4), "cm"),
          legend.margin = margin(rep(-1, 4)),
          legend.key.height = unit(0.4,"cm"),
          legend.box.margin = margin(rep(-1, 4)),
          legend.background = element_rect(fill='transparent'))
legend2 <- get_legend(legend2)

### Put everything together
g1 <- ggplot() +
    geom_spatraster(data = cropland, show.legend = FALSE) +
    scale_fill_material("light-blue", name = "Cropland (%)", na.value = NA) +
    geom_sf(data = habitat_clusters, fill = "#FAE48BFF", 
            color = "#FAE48BFF", linewidth = 0.4) +
    geom_sf(data = waters %>% filter(name == "Lake Victoria"), 
            color = "#00A087FF", fill = "transparent", linewidth = 0.2) +
    geom_sf_text(data = waters %>% filter(name == "Lake Victoria"),
                 aes(label = name), nudge_y = 0.5, nudge_x = 0.3,
                 colour = "black", size = 3) +
    geom_sf(data = bry, color = "black", 
            fill = "transparent", linewidth = 0.3) +
    annotate("text", x = c(35.69, 37.43, 32.48), y = c(-2.57, -9.18, -6.9), 
             label = c(1, 2, 3), fontface = 'bold', size = 4) +
    annotation_custom(grob = legend2, 
                      xmin = 32, xmax = 32,
                      ymin = -11.1, ymax = -11.1) +
    xlab("") + ylab("") +
    bi_theme(bg_color = "transparent") +
    theme(plot.margin = unit(-c(.7, 1.2, 1.0, 2.2), "cm"))

legend2 <- ggplot() +
    geom_spatraster(data = current_map) +
    scale_fill_continuous_sequential(
        palette = "OrYel", name = "Landscape\nconnectivity (0-1)", 
        na.value = NA) +
    theme(plot.margin = unit(rep(0, 4), "cm"),
          legend.margin = margin(rep(-1, 4)),
          legend.key.height = unit(0.4,"cm"),
          legend.box.margin = margin(rep(-1, 4)),
          legend.background = element_rect(fill='transparent'))
legend2 <- get_legend(legend2)

g2 <- ggplot() +
    geom_spatraster(data = current_map, show.legend = FALSE) +
    scale_fill_continuous_sequential(
        palette = "OrYel", name = "Landscape\nconnectivity (%)", 
        na.value = NA) + # OrYel
    geom_sf(data = habitat_clusters, fill = "#D0DFE6FF", 
            color = "#D0DFE6FF", linewidth = 0.4) +
    geom_sf(data = waters %>% filter(name == "Lake Victoria"), 
            color = "#00A087FF", fill = "transparent", linewidth = 0.2) +
    geom_sf_text(data = waters %>% filter(name == "Lake Victoria"),
                 aes(label = name), nudge_y = 0.5, nudge_x = 0.3,
                 colour = "black", size = 3) +
    geom_sf(data = bry, color = "black", 
            fill = "transparent", linewidth = 0.3) +
    annotate("text", x = c(35.69, 37.43, 32.48), y = c(-2.57, -9.18, -6.9), 
             label = c(1, 2, 3), fontface = 'bold', size = 4) +
    annotation_custom(grob = legend2, 
                      xmin = 32, xmax = 32,
                      ymin = -11, ymax = -11) +
    xlab("") + ylab("") +
    bi_theme(bg_color = "transparent") +
    theme(plot.margin = unit(-c(.7, 1.2, 1.0, 2.2), "cm"))

ggarrange(g1, g2, ncol = 2, nrow = 1, 
          labels = c("A", 'B'),
          font.label = list(size = 14, color = "black", face = "bold"))

ggsave(file.path(fg_path, "figureS8_separate_figure6.png"), 
       bg = "white", width = 190, height = 95, 
       units = "mm", dpi = 500)
```

### Figure 7: short-distance landscape connectivity

Prepare the mountains for habitat ecosystem No.2.

```{r}
mnts <- st_read(
    file.path("data/mountains/GMBA_Inventory_v2",
              "GMBA_Inventory_v2.0_standard.shp")) %>% 
    filter(MapUnit == "Aggregated") %>% 
    filter(Level_01 == "Africa") %>% 
    filter(str_detect(Countries, "Tanzania")) %>% 
    filter(Hier_Lvl == 3) %>% 
    filter(Level_03 != "Plateau of Mozambique")
```

Plot

```{r}
# Reload the layers
habitat_clusters <- st_read(file.path(cnt_path, "habitat_clusters.geojson"))
pas <- st_read(file.path(cnt_path, "pas.geojson"))

legend_common <- ggplot() +
    geom_sf(data = pas, aes(color = "Protected areas", 
                            linetype =  "Protected areas"), 
            fill = "transparent", linewidth = 0.2) +
    geom_sf(data = habitat_clusters, 
            aes(color = "Habitat cluster boundary",
                linetype = "Habitat cluster boundary"), 
            fill = "transparent", linewidth = 0.2) +
    scale_color_manual(NULL, values = c("gray40", "black"),
                       breaks = c('Protected areas', 
                                  "Habitat cluster boundary"),
                       guide = guide_legend(order = 2, byrow = TRUE)) +
    scale_linetype_manual(NULL, values = c("solid", "dashed"),
                          breaks = c('Protected areas', 
                                     "Habitat cluster boundary"),
                          guide = guide_legend(order = 2, byrow = TRUE)) +
    theme(text = element_text(size = 12),
          legend.position = "right",
          legend.spacing.y = unit(0.1, 'cm'),
          legend.box = "vertical",
          plot.margin = unit(rep(-1, 4), "cm"),
          legend.key.height = unit(0.3,"cm"),
          legend.key.width = unit(0.3,"cm"),
          legend.margin = margin(rep(0.3, 4)),
          legend.box.margin = margin(rep(0.2, 4)),
          legend.title = element_text(size = 12))
legend_common <- get_legend(legend_common)

legend <- bi_legend(pal = "BlueOr",
                    dim = 4,
                    xlab = "  Connectivity",
                    ylab = "  Farm coverage",
                    size = 9, arrows = TRUE,  pad_width = 0.1) +
    theme(panel.background = element_rect(fill = "transparent", colour = NA),  
          plot.background = element_rect(fill = "transparent", colour = NA),
          axis.title = element_text(size = 9, color = 'black'))
legend <- ggplotGrob(legend)

fg_list <- lapply(1:3, function(cluster_id){
    # Read layers
    current_map <- rast(
        file.path(cnt_exp_path, sprintf("connectivity_c%s.tif", cluster_id)))
    cropland <- rast(file.path(cnt_path, "cropland_ratio.tif")) %>% 
        crop(current_map) %>% mask(current_map)
    
    ## Convert values to biviariates
    data <- values(c(current_map, cropland)) %>% data.frame()
    names(data) <- c("Connectivity", "Cropland")
    data <- data %>% na.omit()
    
    # Manually set the cuts
    data$Connectivity <- cut(
        data$Connectivity, 
        breaks = classIntervals(data$Connectivity,
                                n = 4, style = "quantile")$brks,
        include.lowest = TRUE, dig.lab = 3)
    
    brks <- classIntervals(data$Cropland[data$Cropland > 0], 
                           n = 4, style = "equal")$brks
    data$Cropland <- cut(data$Cropland, breaks = c(0, brks[-1]),
                         include.lowest = TRUE, dig.lab = 3)
    data <- bi_class(data, x = Connectivity, 
                     y = Cropland, style = "quantile", dim = 4)
    
    ## Burn the values into a new layer
    rst <- current_map
    vals <- values(rst)
    vals[!is.na(vals)] <- data$bi_class
    values(rst) <- vals
    rst[rst == "NaN"] <- NA
    
    # Read boundaries
    cluster <- habitat_clusters %>% filter(cluster == cluster_id)
    pas_c <- pas %>% filter(cluster == cluster_id)
    if (cluster_id == 1){
        pas_to_show <- pas_c %>% 
            filter(park_name %in% c(
                "Serengeti National Park",
                "Ngorongoro Conservation Area",
                "Tarangire National Park",
                "Lake Manyara National Park"))
        pas_to_show$park_name <- c(
            "Serengeti NP",
            "Ngorongoro CA",
            "Tarangire NP",
            "Lake Manyara NP")
    } else if (cluster_id == 2){
        pas_to_show <- pas_c %>% 
            filter(park_name %in% c("Selous G.R"))
    } else {
        pas_to_show <- pas_c %>% 
            filter(park_name %in% c("Wembere GCA", "Rungwa (N) O.A.", 
                                    "Inyonga GCA"))
    }
    
    bry <- st_union(pas_c) %>% st_convex_hull() %>% 
        st_as_sf() %>% rename(geometry = x)
    
    # Plot
    p <- ggplot() +
        geom_spatraster(data = rst, show.legend = FALSE) +
        bi_scale_fill(pal = "BlueOr", dim = 4, na.value = NA) +
        geom_sf(data = pas_c, color = "gray40", linewidth = 0.4,
                fill = "transparent") +
        geom_sf(data = bry, color = "black", 
                fill = "transparent") +
        geom_sf(data = cluster, color = "black", 
                fill = "transparent", linewidth = 0.4, linetype = "dashed")
    
    if (cluster_id == 1){
        p <- p + geom_sf_text_repel(
            data = pas_to_show, fontface='bold',
            aes(label = park_name), colour = "black", size = 3, 
            nudge_y = 0.1, nudge_x = 1, force = 100) +
            annotation_custom(grob = legend, 
                              xmin = 33.6, xmax = 35.55,
                              ymin = -5.7, ymax = -3.75)
    } else if (cluster_id == 2){
        p <- p + geom_sf_text_repel(
            data = pas_to_show, fontface='bold',
            aes(label = park_name), colour = "black", size = 3, 
            nudge_y = 0.1, nudge_x = 0, force = 100) +
            geom_text(aes(x = 36.2, y = -8.5, label = "A"),
                      size = 4, fontface = 'bold', color = "black")
    } else {
        p <- p + geom_sf_text_repel(
            data = pas_to_show[1, ], fontface='bold',
            aes(label = park_name), colour = "black", size = 3, 
            nudge_y = 0.8, nudge_x = -0.5, force = 100) +
            geom_sf_text_repel(
            data = pas_to_show[2, ], fontface='bold',
            aes(label = park_name), colour = "black", size = 3, 
            nudge_y = -0.7, nudge_x = 0.2, force = 100) +
            geom_sf_text_repel(
            data = pas_to_show[3, ], fontface='bold',
            aes(label = park_name), colour = "black", size = 3, 
            nudge_y = 0.5, nudge_x = -1, force = 100) +
            annotation_custom(grob = legend_common, 
                              xmin = 32.8, xmax = 34.8,
                              ymin = -4, ymax = -3)
    }

    p + xlab("") + ylab("") +
        bi_theme(bg_color = "white") +
        # unit(c(-0.2, -0.4, -1, -1.8), "cm")
        theme(plot.margin = unit(c(-0.2, -0.5, -1.1, -1.8), "cm"),
              panel.background = element_rect(fill = "transparent", colour = NA),  
              plot.background = element_rect(fill = "transparent", colour = NA))
})

ggarrange(plotlist = fg_list, ncol = 3, nrow = 1, 
          labels = c("1", '2', '3'), label.x = c(0, 0.28, -0.08),
          font.label = list(size = 14, color = "black", face = "bold"))

ggsave(file.path(fg_path, "figure7_clusters.png"), 
       bg = "white", width = 190, height = 70, 
       units = "mm", dpi = 500)
```

### Figure S9: seperate short-distance connectivity

```{r}
# Reload the layers
habitat_clusters <- st_read(file.path(cnt_path, "habitat_clusters.geojson"))
pas <- st_read(file.path(cnt_path, "pas.geojson"))

legend1 <- ggplot() +
    geom_spatraster(data = cropland * 100) +
    scale_fill_material("light-blue", name = "Cropland (%)", na.value = NA) +
    theme(plot.margin = unit(rep(0, 4), "cm"),
          legend.margin = margin(rep(-1, 4)),
          legend.key.height = unit(0.3,"cm"),
          legend.key.width = unit(0.2,"cm"),
          legend.box.margin = margin(rep(-1, 4)),
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.background = element_rect(fill='transparent'))
legend1 <- get_legend(legend1)

legend2 <- ggplot() +
    geom_spatraster(data = current_map) +
    scale_fill_continuous_sequential(
        palette = "OrYel", name = "Landscape\nconnectivity (0-1)", 
        na.value = NA) +
    theme(plot.margin = unit(rep(0, 4), "cm"),
          legend.margin = margin(rep(-1, 4)),
          legend.key.height = unit(0.3,"cm"),
          legend.key.width = unit(0.2,"cm"),
          legend.box.margin = margin(rep(-1, 4)),
          legend.text = element_text(size = 8),
          legend.title = element_text(size = 8),
          legend.background = element_rect(fill='transparent'))
legend2 <- get_legend(legend2)

fg_list <- lapply(1:3, function(cluster_id){
    # Read layers
    current_map <- rast(file.path(cnt_exp_path, sprintf("connectivity_c%s.tif", cluster_id)))
    cropland <- rast(file.path(cnt_path, "cropland_ratio.tif")) %>% 
        crop(current_map) %>% mask(current_map)
    
    # Read boundaries
    cluster <- habitat_clusters %>% filter(cluster == cluster_id)
    pas_c <- pas %>% filter(cluster == cluster_id)
    bry <- st_union(pas_c) %>% st_convex_hull() %>% 
        st_as_sf() %>% rename(geometry = x)
    
    # Plot
    p1 <- ggplot() +
        geom_spatraster(data = cropland, show.legend = FALSE) +
        scale_fill_material("light-blue", name = "Cropland (%)", na.value = NA) +
        geom_sf(data = pas_c, color = "gray40", linewidth = 0.4,
                fill = "transparent") +
        geom_sf(data = bry, color = "black", 
                fill = "transparent") +
        geom_sf(data = cluster, color = "black", 
                fill = "transparent", linewidth = 0.4, linetype = "dashed") +
        xlab("") + ylab("") +
        bi_theme(bg_color = "white") +
        # unit(c(-0.2, -0.4, -1, -1.8), "cm")
        theme(plot.margin = unit(c(-0.2, -0.5, -1.1, -1.8), "cm"),
              panel.background = element_rect(fill = "transparent", colour = NA),  
              plot.background = element_rect(fill = "transparent", colour = NA))
    
    p2 <- ggplot() +
        geom_spatraster(data = current_map, show.legend = FALSE) +
        scale_fill_continuous_sequential(
            palette = "OrYel", name = "Landscape\nconnectivity (0-1)", 
            na.value = NA) +
        geom_sf(data = pas_c, color = "gray40", linewidth = 0.4,
                fill = "transparent") +
        geom_sf(data = bry, color = "black", 
                fill = "transparent") +
        geom_sf(data = cluster, color = "black", 
                fill = "transparent", linewidth = 0.4, linetype = "dashed") +
        xlab("") + ylab("") +
        bi_theme(bg_color = "white") +
        # unit(c(-0.2, -0.4, -1, -1.8), "cm")
        theme(plot.margin = unit(c(-0.2, -0.5, -1.1, -1.8), "cm"),
              panel.background = element_rect(fill = "transparent", colour = NA),  
              plot.background = element_rect(fill = "transparent", colour = NA))
    
    if (cluster_id == 1){
        p1 <- p1 + 
            annotation_custom(grob = legend1, 
                              xmin = 33.6, xmax = 35.55,
                              ymin = -5.7, ymax = -3.75)
        
        p2 <- p2 + 
            annotation_custom(grob = legend2, 
                              xmin = 33.6, xmax = 35.55,
                              ymin = -5.7, ymax = -3.75)
    }
    
    label.x <- ifelse(cluster_id == 1, -0.04, ifelse(cluster_id == 2, 0.22, -0.12))
    
    ggarrange(p1, p2, ncol = 1, nrow = 2, label.x = label.x, 
              labels = sprintf("%s.%s", cluster_id, c("A", "B")), 
              font.label = list(size = 14, color = "black", face = "bold"))
})

ggarrange(plotlist = fg_list, ncol = 3, nrow = 1)

ggsave(file.path(fg_path, "figureS9_separate_figure7.png"), 
       bg = "white", width = 190, height = 130, 
       units = "mm", dpi = 500)
```

### Supplementary Figure S2: protected areas (PAs)

```{r}
study_area <- read_sf(
    file.path(vct_path, "mainland_tanzania.geojson"))
pas <- read_sf(file.path(cnt_path, "pas.geojson"))
clusters <- st_read(file.path(cnt_path, "habitat_clusters.geojson"))

# Read other PAs
pas_others <- read_sf(file.path(vct_path, "wdpa_selected.geojson"))
pas_others <- pas_others %>% 
    slice(-unique(unlist(st_intersects(pas, pas_others))))

brys <- do.call(rbind, lapply(1:3, function(id){
    pas %>% filter(cluster == id) %>% 
        st_union() %>% st_convex_hull() %>% 
        st_as_sf() %>% rename(geometry = x)
})) %>% mutate(id = 1:3)

# Plot
options(ggrepel.max.overlaps = Inf) # May need to change back when done
ggplot() +
    geom_sf(data = study_area, 
            fill = "transparent", color = "grey", linewidth = 0.6) +
    geom_sf(data = brys, 
            fill = "transparent", 
            aes(color = "Convex hull"), linewidth = 0.6) +
    geom_sf(data = pas, 
            fill = "transparent", 
            aes(color = 'PAs used for connectivity')) +
    geom_sf(data = pas_others %>% 
                mutate(area = st_area(.)) %>% 
                filter(area > 20000000 %>% units::set_units("m2")),
            fill = "transparent", 
            aes(color = "Other PAs")) +
    annotate("text", x = c(35.69, 37.44, 32.7), y = c(-3.3, -9, -6.7), 
             label = c(1, 2, 3), fontface = 'bold', size = 6) +
    scale_color_manual(
        NULL, values = c("blue", "gray40", "orange"),
        breaks = c("Convex hull", 
                   'PAs used for connectivity', 
                   "Other PAs")) +
    geom_sf_text_repel(
        data = pas, fontface = 'bold',
        aes(label = park_name), colour = "black", size = 3, 
        nudge_y = 0.5, nudge_x = -1, force = 100) +
    theme_void() +
    theme(text = element_text(size = 10),
          legend.text = element_text(size = 12),
          legend.spacing.y = unit(0.1, 'cm'),
          legend.margin = margin(rep(0, 4)), 
          legend.key.height= unit(0.4, 'cm'),
          legend.key.width= unit(0.4, 'cm'),
          plot.margin = unit(c(0, 0, 0, 0), "cm"),
          legend.position = "bottom",
          legend.box.just = "left",
          legend.box = "vertical")

ggsave(file.path(fg_path, "figureS2_PA.png"), 
       bg = "white", width = 190, height = 190, 
       units = "mm", dpi = 500)
```

### Supplementary Figure S3: effect of sampling ratio

```{r}
evals <- do.call(rbind, lapply(c(10, 5, 2.5), function(scale){
    do.call(rbind,lapply(c(0.1, 0.2, 0.3, 0.4, 0.5), function (ratio) {
        load(file.path(result_path, 
                       sprintf("tuning_cv_%s_%s.rda", scale, ratio)))
        
        tuning_cv %>% 
            select(sample_size, max_depth, ndim, scoring_metric,
                   cbi, auc_ratio, TSS, auc, `f-measure`) %>% 
            mutate(ratio = ratio)
    })) %>% mutate(scale = scale)
})) %>% rename(CBI = cbi, `AUC (ratio)` = auc_ratio, 
               AUC = auc, `F-measure` = `f-measure`)

# Check and compare the results
evals <- evals %>%
    pivot_longer(cols = c(`AUC (ratio)`, AUC, `F-measure`),
                 names_to = "metrics", values_to = "value") %>% 
    mutate(scale = factor(scale, levels = c(2.5, 5, 10)),
           ratio = factor(ratio, levels = c(0.1, 0.2, 0.3, 0.4, 0.5))) %>% 
    select(ratio, scale, metrics, value)

facet_names <- c("2.5 minutes", "5 minutes", "10 minutes")
names(facet_names) <- c("2.5", "5", "10")
ggplot(evals, 
       aes(x = ratio, y = value, fill = metrics, color = metrics)) +
    geom_boxplot(outlier.colour = "white", outlier.shape = 8,
                 outlier.size = 1, width = 0.5,
                 position = position_dodge(width = 0.9)) +
    stat_summary(
        fun = median,
        geom = 'line',
        size = 0.6, 
        aes(group = metrics, colour = metrics),
        position = position_dodge(width = 0.9)) +
    scale_fill_brewer("Evaluation metrics", palette = "Dark2",
                      labels = c("AUC",
                                  expression(paste(AUC[ratio])),
                                  "F-measure")) +
    scale_color_brewer("Evaluation metrics", palette = "Dark2",
                       labels = c("AUC",
                                  expression(paste(AUC[ratio])),
                                  "F-measure")) +
    stat_summary(
        fun = median,
        geom = 'point',
        color = "black",
        shape = "-",
        size = 5, 
        aes(group = metrics),
        position = position_dodge(width = 0.9),
        show.legend = FALSE) +
    facet_wrap(~scale, scales = "free_y", 
               labeller = labeller(scale = facet_names)) +
    ylab('') +
    xlab('Sampling ratio of pseudo occurrences') +
    theme_pubclean() +
    theme(text = element_text(size = 12, color = "black"),
          axis.text.x = element_text(angle = 0),
          axis.text = element_text(size = rel(0.8)),
          axis.title = element_text(size = rel(1)),
          legend.text = element_text(size = rel(1)),
          legend.position = "top",
          strip.text.x = element_text(size = 12, face = "bold")) +
    guides(fill = guide_legend(nrow = 1))

ggsave(file.path(fg_path, "figureS3_pseudo_sample_190w_95h_500dpi_1.5c.png"), 
       bg = "white", width = 190, height = 95, 
       units = "mm", dpi = 500)
```

### Supplementary Figure S4: performance of regional SDM at different scales

```{r}
library(tidyverse)
library(ggpubr)

tabularize_evaluation <- function(eval, type = "train") {
    if (type == "train") {
        tibble(
            CBI = eval$po_evaluation$boyce$cor,
            `AUC (ratio)` = eval$po_evaluation$roc_ratio$auc_ratio,
            TSS = eval$pb_evaluation$TSS$`Optimal TSS`,
            AUC = eval$pb_evaluation$roc$auc,
            Sensitivity = eval$pb_evaluation$sensitivity,
            `F-measure` = eval$pb_evaluation$`f-measure`)
    } else {
        tibble(
        Specificity = eval$pb_evaluation$specificity)
    }
}

evals_train <- do.call(rbind, lapply(c(10, 5, 2.5), function(scale){
    load(file.path(result_path, sprintf("runs_%s.rda", scale)))
    
    do.call(rbind, lapply(runs, function(run) {
        tabularize_evaluation(run$eval_test)
    })) %>% mutate(scale = scale)
}))

evals_sensitivity <- do.call(rbind, lapply(c(10, 5, 2.5), function(scale){
    load(file.path(result_path, sprintf("stt_real_same_%s.rda", scale)))
    
     do.call(rbind, lapply(sensitivity_real, function(each) {
        data.frame("Sensitivity" = each)
    })) %>% mutate(scale = scale)
}))

# Check and compare the results
evals_train <- evals_train %>% 
    pivot_longer(cols = c(`AUC (ratio)`, AUC, `F-measure`),
                 names_to = "metrics", values_to = "value") %>% 
    select(scale, metrics, value) %>% 
    mutate(scale = factor(
        scale, levels = c(2.5, 5, 10),
        labels = c("2.5 minutes", "5 minutes", "10 minutes")))

evals_sensitivity <- evals_sensitivity %>% 
    pivot_longer(cols = c(Sensitivity),
                 names_to = "metrics", values_to = "value") %>% 
    select(scale, metrics, value) %>% 
    mutate(scale = factor(
        scale, levels = c(2.5, 5, 10),
        labels = c("2.5 minutes", "5 minutes", "10 minutes")))

g_train <- ggplot(evals_train, 
       aes(x = metrics, y = value, fill = scale)) +
    geom_boxplot(outlier.colour = "black", outlier.alpha = 0,
                 outlier.size = 1) +
    scale_fill_brewer("Scale", palette = "Dark2") +
    scale_color_brewer("Scale", palette = "Dark2") +
    scale_x_discrete(limits = c("AUC", "AUC (ratio)", "F-measure"),
                     labels = c("AUC", expression("AUC"[ratio]), "F-measure")) +
    ylab('') +
    xlab('') +
    theme_classic() +
    theme(text = element_text(size = 11),
          axis.text.x = element_text(angle = 0),
          axis.text = element_text(size = rel(0.8)),
          axis.title = element_text(size = rel(1)),
          legend.text = element_text(size = rel(1)),
          legend.position = "top") +
    guides(fill = guide_legend(nrow = 2))

g_eval_stt <- ggplot(evals_sensitivity, 
                  aes(x = metrics, y = value, fill = scale)) +
    geom_boxplot(outlier.colour = "white", outlier.shape = 8,
                 outlier.size = 2) +
    scale_fill_brewer("Scale", palette = "Dark2") +
    ylab('') +
    xlab('') +
    theme_classic() +
    theme(text = element_text(size = 11),
          axis.text.x = element_text(angle = 0),
          axis.text = element_text(size = rel(0.8)),
          axis.title = element_text(size = rel(1)),
          legend.text = element_text(size = rel(1)),
          legend.position = "top") +
    guides(fill = guide_legend(nrow = 2))

figure <- ggarrange(g_train, g_eval_stt, 
                    labels = c("A", "B"),
                    font.label = list(size = 12, color = "black", 
                                      face = "bold"),
                    widths = c(2, 1),
                    common.legend = TRUE)

# Annotate the figure by adding a common labels
annotate_figure(figure,
                bottom = text_grob("Evaluation metrics", 
                                   color = "black", 
                                   size = 10, vjust = -1))

ggsave(file.path(fg_path, "figureS4_eval_coarse_90w_80h_500dpi_1c.png"), 
       bg = "white", width = 90, height = 80, 
       units = "mm", dpi = 500)
```

### Supplementary Figure S5-S7: Response curve of all variables at coarse scale

```{r}
var_rsp <- do.call(rbind, lapply(c(10, 5, 2.5), function(scale){
    template <- rast(file.path(hr_path, sprintf("bios_%s.tif", scale)), 
                     lyrs = 1)
    ar <- global(cellSize(template, unit = "km"), "mean", na.rm = TRUE)[[1]]
    
    load(file.path(result_path, sprintf("runs_%s.rda", scale)))
    
    dat <- do.call(rbind, lapply(runs, function(run) {
        shaps <- run$shap_dependences$dependences_cont
        names(shaps) <- nms
        do.call(rbind, lapply(nms, function(nm) {
            shaps[[nm]] %>% mutate(variable = nm)
        }))
    })) %>% mutate(scale = scale)
    
    dat[dat$variable %in% 
            c("Road density", "River density", "Settlement density"), 'x'] <- 
        dat[dat$variable %in% 
            c("Road density", "River density", "Settlement density"), 'x'] / ar
    rownames(dat) <- NULL
    dat
}))

## Reformat the table
var_rsp <- var_rsp %>% 
    mutate(scale = factor(scale, levels = c("2.5", "5", "10")))

# Types
type_a <- c(nms[1:8], "River density", "Road density", 
            "Settlement density", "Cropland edge density", 
            "Patch density", "Coverage of waterbodies", 
            "Patch density (open habitat)", 
            "Edge density (closed canopy habitat)")
type_b <- c("Surface roughness",
            "Mean of Contiguity index (open habitat)")
type_c <- c("Shannon's diversity index", "Patch richness density", 
            "Coverage of open habitat")

# x value transition
group_orig <- c(nms[1:8], "Mean of Contiguity index (open habitat)",
                "Shannon's diversity index", "Coverage of open habitat",
                "Patch density (open habitat)", "Patch density", 
                "Edge density (closed canopy habitat)")
group_log <- c("Cropland edge density", 
               "Coverage of waterbodies", 
               "River density", "Road density", 
               "Settlement density", "Surface roughness", 
               "Patch richness density")

## Plot lists
fg_orig_list <- lapply(group_orig, function(nm) {
    set.seed(123)
    
    if (nm == "Mean of Contiguity index (open habitat)") {
        data <- var_rsp %>% 
            filter(variable == nm) %>% 
            group_by(scale) %>% 
            sample_n(size = 7000) %>% 
            ungroup()
        ggplot(data) +
            geom_point(aes(x = x, y = y, fill = scale), pch = 21,
                       color = "white", size = 0.8, stroke = 0.2) +
            geom_smooth(data = data %>% filter(x > 0 & x < 0.95),
                        aes(x = x, y = y, color = scale, fill = scale),
                        se = TRUE, level = 0.95, method = 'gam', linewidth = 0.7,
                        formula = y ~ s(x, bs = "cs", k = 4)) +
            scale_color_brewer("Scale", palette = "Dark2") +
            scale_fill_brewer("Scale", palette = "Dark2") +
            geom_hline(yintercept = 0, linetype = "dashed") +
            ylim(c(-0.08, 0.02)) +
            ylab('Shapley value') +
            xlab(expression(CONTIG[NM]~(open~habitat))) +
            theme_classic() +
            theme(text = element_text(size = 10, color = "black"),
                  axis.text.x = element_text(angle = 0),
                  axis.text = element_text(size = rel(0.8)),
                  axis.title = element_text(size = rel(1)),
                  legend.text = element_text(size = rel(1)),
                  legend.position = "top") +
            guides(fill = guide_legend(nrow = 1))
    } else if (nm == "Coverage of open habitat") {
        data <- var_rsp %>% 
            filter(variable == nm) %>% 
            group_by(scale) %>% 
            sample_n(size = 7000) %>% 
            ungroup()
        ggplot(data) +
            geom_point(aes(x = x, y = y, fill = scale), pch = 21,
                       color = "white", size = 0.8, stroke = 0.2) +
            geom_smooth(data = data %>% filter(x < 0.99),
                        aes(x = x, y = y, color = scale, fill = scale),
                        se = TRUE, level = 0.95, linewidth = 0.8,
                        method = 'gam', formula = y ~ s(x, bs = "cs", k = 5)) +
            scale_color_brewer("Scale", palette = "Dark2") +
            scale_fill_brewer("Scale", palette = "Dark2") +
            geom_hline(yintercept = 0, linetype = "dashed") +
            # scale_x_log10() +
            ylab('Shapley value') +
            xlab(nm) +
            theme_classic() +
            theme(text = element_text(size = 10, color = "black"),
                  axis.text.x = element_text(angle = 0),
                  axis.text = element_text(size = rel(0.8)),
                  axis.title = element_text(size = rel(1)),
                  legend.text = element_text(size = rel(1)),
                  legend.position = "top") +
            guides(fill = guide_legend(nrow = 1))
    } else {
        data <- var_rsp %>% 
            filter(variable == nm) %>% 
            group_by(scale) %>% 
            sample_n(size = 7000) %>%  
            ungroup()
            
        if (nm == "Patch density (open habitat)"){
            data <- data %>% filter(x < 500)
        }
        ggplot(data) +
            geom_point(aes(x = x, y = y, fill = scale), pch = 21,
                       color = "white", size = 0.8, stroke = 0.2) +
            geom_smooth(aes(x = x, y = y, color = scale, fill = scale),
                        se = TRUE, level = 0.95, linewidth = 0.8,
                        method = 'gam', formula = y ~ s(x, bs = "cs", k = 6)) +
            scale_color_brewer("Scale", palette = "Dark2") +
            scale_fill_brewer("Scale", palette = "Dark2") +
            geom_hline(yintercept = 0, linetype = "dashed") +
            # scale_x_log10() +
            ylab('Shapley value') +
            xlab(nm) +
            theme_classic() +
            theme(text = element_text(size = 10, color = "black"),
                  axis.text.x = element_text(angle = 0),
                  axis.text = element_text(size = rel(0.8)),
                  axis.title = element_text(size = rel(1)),
                  legend.text = element_text(size = rel(1)),
                  legend.position = "top") +
            guides(fill = guide_legend(nrow = 1))
    }
})

names(fg_orig_list) <- group_orig

fg_log_list <- lapply(group_log, function(nm) {
    set.seed(123)
    
    nm_label <- parse(text = paste0(gsub(" ", "~", nm), "~''^'L'"))
    if (nm == "Patch richness density") {
        data <- var_rsp %>% 
            filter(variable == nm) %>% 
            group_by(scale) %>% 
            sample_n(size = 7000) %>%  
            ungroup()
        ggplot(data) +
            geom_point(aes(x = x, y = y, fill = scale), pch = 21,
                       color = "white", size = 0.8, stroke = 0.2) +
            geom_smooth(aes(x = x, y = y, color = scale, fill = scale),
                        se = TRUE, level = 0.95, linewidth = 0.8) +
            scale_color_brewer("Scale", palette = "Dark2") +
            scale_fill_brewer("Scale", palette = "Dark2") +
            geom_hline(yintercept = 0, linetype = "dashed") +
            scale_x_log10() +
            ylab('Shapley value') +
            xlab(nm_label) +
            theme_classic() +
            theme(text = element_text(size = 10, color = "black"),
                  axis.text.x = element_text(angle = 0),
                  axis.text = element_text(size = rel(0.8)),
                  axis.title = element_text(size = rel(1)),
                  legend.text = element_text(size = rel(1)),
                  legend.position = "top") +
            guides(fill = guide_legend(nrow = 1))
    } else {
        ggplot(var_rsp %>% 
                   filter(variable == nm) %>% 
                   group_by(scale) %>% 
                   sample_n(size = 7000) %>%  
                   ungroup()) +
            geom_point(aes(x = x, y = y, fill = scale), pch = 21,
                       color = "white", size = 0.8, stroke = 0.2) +
            geom_smooth(aes(x = x, y = y, color = scale, fill = scale),
                        se = TRUE, level = 0.95, linewidth = 0.8,
                        method = 'gam', formula = y ~ s(x, bs = "cs", k = 5)) +
            scale_color_brewer("Scale", palette = "Dark2") +
            scale_fill_brewer("Scale", palette = "Dark2") +
            geom_hline(yintercept = 0, linetype = "dashed") +
            scale_x_log10() +
            ylab('Shapley value') +
            xlab(nm_label) +
            theme_classic() +
            theme(text = element_text(size = 10, color = "black"),
                  axis.text.x = element_text(angle = 0),
                  axis.text = element_text(size = rel(0.8)),
                  axis.title = element_text(size = rel(1)),
                  legend.text = element_text(size = rel(1)),
                  legend.position = "top") +
            guides(fill = guide_legend(nrow = 1))
    }
})
names(fg_log_list) <- group_log

fg_list <- c(fg_orig_list, fg_log_list)

id_type_a <- which(names(fg_list) %in% type_a)
id_type_b <- which(names(fg_list) %in% type_b)
id_type_c <- which(names(fg_list) %in% type_c)
fg_type_a <- fg_list[id_type_a]
fg_type_b <- fg_list[id_type_b]
fg_type_c <- fg_list[id_type_c]

ggarrange(plotlist = fg_type_a, 
          ncol = 3, nrow = 6,
          common.legend = TRUE)

ggsave(file.path(fg_path, "figureS5_variable_response_a.png"), 
       width = 6.5, height = 9.5, dpi = 500, bg = "white")

ggarrange(plotlist = fg_type_b, 
          ncol = 2, nrow = 1,
          common.legend = TRUE)

ggsave(file.path(fg_path, "figureS6_variable_response_b.png"), 
       width = 4.3, height = 2.5, dpi = 500, bg = "white")

ggarrange(plotlist = fg_type_c, 
          ncol = 2, nrow = 2,
          common.legend = TRUE)

ggsave(file.path(fg_path, "figureS7_variable_response_c.png"), 
       width = 4.3, height = 4.3, dpi = 500, bg = "white")
```
