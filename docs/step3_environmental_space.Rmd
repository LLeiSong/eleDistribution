---
title: "Environmental space at hierarchical scales"
author: "Lei Song"
date: "6/1/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(sf)
library(stars)
library(ggplot2)

data_path <- here("data")
result_path <- here("results")
```

## Introduction

We will first target the climatic domain (or environmental space) of African elephant at different scales using Isolation Forest. Variables at broad scale (e.g. climatic vars) and variables with long history (e.g. NDVI and its trend) will be used in this step. The idea is to first target the highly possible suitable environmental areas (like fundamental niche), then to detail the environmental suitability according to other environmental constraints (like realistic niche).

## Monte Carlo simulation

```{r}
library(sf)
library(stars)
library(dplyr)
library(tmap)
library(stringr)
library(itsdm, quietly = TRUE)
library(caret)
library(parallel)
source(file.path(here(), "scripts/ul_env_space_modeling.R"))

# Run Monte Carlo simulation
# "1km", "2km", "4km", "6km", "8km", "10km"
scales <- c("1km", "2km", "4km", "6km", "8km", "10km")
lapply(scales, function(scale) {
    message(sprintf("Run simulation at %s scale.", scale))
    ul_env_space_modeling(data_path, result_path, scale)
})
```

## Analysis

```{r}
library(tidyverse)
source(file.path(here(), "scripts/ul_simulation_gather.R"))

# Read data
scale <- "1km"
sim_gather <- ul_simulation_gather(result_path, scale)
save(sim_gather, file = file.path(result_path, 
                          sprintf("sim_gather_%s.rda", scale)))
```
